/**
 * Right Activity Bar - Vertical tabs for right-side panels
 * Similar to left sidebar activity bar, but for panels like Chat, Preview, Inspector, Monitor
 * Additional tabs: Overview, Details, Settings - each with independent panels that slide in from left
 * 
 * UPDATED: All panels now have identical, uniform sizes using CSS Grid/Flexbox
 * Panel sizing uses CSS variables from design-tokens.css
 */

import React, { useState, useCallback } from 'react';
import { 
  Sparkles, 
  Eye, 
  Activity, 
  Terminal,
  LayoutDashboard,
  Settings,
  Info,
  X
} from 'lucide-react';

interface RightActivityBarProps {
  chatVisible?: boolean;
  previewVisible?: boolean;
  inspectorVisible: boolean;
  monitorVisible: boolean;
  onToggleChat?: () => void;
  onTogglePreview?: () => void;
  onToggleInspector: () => void;
  onToggleMonitor: () => void;
  onClosePreview?: () => void;
  onCloseInspector?: () => void;
  onCloseMonitor?: () => void;
}

interface PanelTabProps {
  icon: React.ReactNode;
  label: string;
  active: boolean;
  onClick: () => void;
  tooltip: string;
}

// Fixed CSS values for uniform sizing - these match the CSS variables
const PANEL_TAB_STYLES = {
  width: '100%',
  height: 'var(--panel-tab-height, 120px)',
  minHeight: '120px',
  maxHeight: '120px',
} as const;

const PanelTab: React.FC<PanelTabProps> = ({ icon, label, active, onClick, tooltip }) => {
  return (
    <div className="relative group/panel" style={{ marginBottom: '6px' }}>
      <button
        onClick={onClick}
        title={tooltip}
        style={PANEL_TAB_STYLES}
        className={`
          flex flex-col items-center justify-between
          rounded-tl-lg rounded-bl-lg
          transition-all duration-300 ease-out relative overflow-hidden cursor-pointer
          ${active 
            ? 'bg-gradient-to-r from-slate-800 via-slate-700 to-slate-800 shadow-md ring-1 ring-white/10 dark:from-slate-800 dark:via-slate-700 dark:to-slate-800' 
            : 'bg-gradient-to-r from-slate-800/60 via-slate-700/40 to-slate-800/60 hover:from-slate-800/80 hover:via-slate-700/60 hover:to-slate-800/80 hover:ring-1 hover:ring-white/5'
          }
        `}
      >
        {/* Smooth lighting effect overlay */}
        {active && (
          <>
            <div className="absolute inset-0 rounded-tl-lg rounded-bl-lg bg-gradient-to-br from-white/12 via-white/6 to-transparent" />
            <div className="absolute inset-0 rounded-tl-lg rounded-bl-lg bg-gradient-to-t from-white/5 via-white/2 to-transparent" />
            <div className="absolute inset-0 rounded-tl-lg rounded-bl-lg bg-gradient-to-r from-transparent via-white/4 to-transparent" />
          </>
        )}
        
        {/* Smooth hover glow */}
        {!active && (
          <div className="absolute inset-0 rounded-tl-lg rounded-bl-lg bg-gradient-to-br from-white/6 via-white/3 to-transparent opacity-0 group-hover/panel:opacity-100 transition-opacity duration-300 ease-out" />
        )}

        {/* Top Icon Section - Rotated 90° clockwise */}
        <div className="relative z-10 flex items-center justify-center pt-3 pb-2 transition-transform duration-300 ease-out group-hover/panel:scale-105 flex-shrink-0">
          <div 
            className="text-white"
            style={{ 
              transform: 'rotate(90deg)',
              filter: 'drop-shadow(0 1px 2px rgba(0, 0, 0, 0.6)) drop-shadow(0 0 4px rgba(255, 255, 255, 0.3))',
              transformOrigin: 'center'
            }}
          >
            {icon}
          </div>
        </div>

        {/* Divider line */}
        <div className={`w-6 h-px flex-shrink-0 ${active ? 'bg-white/18' : 'bg-slate-600/25'}`} />

        {/* Vertical Label Section - Rotated 90° clockwise */}
        <div className="relative z-10 flex-1 flex items-center justify-center px-0.5 pb-3 min-h-0">
          <div
            style={{ 
              transform: 'rotate(90deg)',
              transformOrigin: 'center'
            }}
          >
            <span 
              className="text-[11px] font-bold uppercase tracking-[0.15em] text-white whitespace-nowrap"
              style={{ 
                letterSpacing: '0.15em',
                textShadow: '0 1px 3px rgba(0, 0, 0, 0.7), 0 0 6px rgba(255, 255, 255, 0.35), 0 2px 4px rgba(0, 0, 0, 0.5)',
                WebkitTextStroke: '0.3px rgba(255, 255, 255, 0.25)',
                display: 'inline-block',
                lineHeight: '1.5',
                fontWeight: 700,
                WebkitFontSmoothing: 'antialiased',
                MozOsxFontSmoothing: 'grayscale'
              }}
            >
              {label}
            </span>
          </div>
        </div>
      </button>
      
      {/* Tooltip */}
      <div className="absolute right-full mr-4 px-3 py-1.5 bg-slate-800 text-white text-[10px] rounded-lg opacity-0 group-hover/panel:opacity-100 pointer-events-none transition-all duration-200 whitespace-nowrap z-50 font-medium translate-x-[10px] group-hover/panel:translate-x-0 shadow-xl">
        {tooltip}
        <div className="absolute top-1/2 -right-1 -mt-1 border-4 border-transparent border-l-slate-800" />
      </div>
    </div>
  );
};

export const RightActivityBar: React.FC<RightActivityBarProps> = ({
  chatVisible,
  previewVisible,
  inspectorVisible,
  monitorVisible,
  onToggleChat,
  onTogglePreview,
  onToggleInspector,
  onToggleMonitor,
  onClosePreview,
  onCloseInspector,
  onCloseMonitor
}) => {
  // Only one panel can be active at a time
  const [activePanel, setActivePanel] = useState<'overview' | 'details' | 'settings' | null>(null);
  
  const [items, setItems] = useState<Array<{ id: number; name: string; description: string }>>([]);
  const [newItemName, setNewItemName] = useState('');

  const handleAddItem = useCallback(() => {
    if (newItemName.trim()) {
      const newItem = { id: Date.now(), name: newItemName, description: 'New item description' };
      setItems(prev => [...prev, newItem]);
      setNewItemName('');
    }
  }, [newItemName]);

  // Handle tab toggle - close current if clicking same tab, otherwise switch
  // Also close main panels when opening Overview/Details/Settings
  const handleTogglePanel = useCallback((panelType: 'overview' | 'details' | 'settings') => {
    if (activePanel === panelType) {
      setActivePanel(null);
    } else {
      // Close main panels when opening Overview/Details/Settings
      if (previewVisible && onClosePreview) onClosePreview();
      if (inspectorVisible && onCloseInspector) onCloseInspector();
      if (monitorVisible && onCloseMonitor) onCloseMonitor();
      setActivePanel(panelType);
    }
  }, [activePanel, previewVisible, inspectorVisible, monitorVisible, onClosePreview, onCloseInspector, onCloseMonitor]);

  // Panel content container styles - UNIFORM for all panels
  const panelContainerStyle = {
    width: 'var(--right-sidebar-width, 300px)',
    minWidth: '300px',
    maxWidth: '300px',
  } as const;

  const panelHeaderStyle = {
    height: 'var(--panel-header-height, 52px)',
    minHeight: '52px',
  } as const;

  // Get the active panel content
  const getActivePanelContent = () => {
    if (!activePanel) return null;

    switch (activePanel) {
      case 'settings':
        return (
          <div className="h-full flex flex-col bg-slate-900/80 backdrop-blur-md">
            <div 
              style={panelHeaderStyle}
              className="px-6 flex items-center justify-between border-b border-slate-800/60 bg-slate-900/80 backdrop-blur-md shrink-0"
            >
              <div className="flex items-center gap-2 text-[11px] font-black uppercase tracking-widest text-slate-200">
                <Settings strokeWidth={2} className="w-3.5 h-3.5 text-emerald-400" />
                <span>Settings</span>
              </div>
              <button
                onClick={() => setActivePanel(null)}
                className="p-2 rounded-lg hover:bg-slate-700/50 text-slate-400 hover:text-slate-200 transition-all"
              >
                <X strokeWidth={1.5} className="w-4 h-4" />
              </button>
            </div>
            <div className="flex-1 overflow-y-auto p-4 space-y-4 min-h-0" style={{ minHeight: 'var(--panel-min-height, 300px)' }}>
              {/* Empty state - same structure as other panels */}
              {items.length === 0 && (
                <div className="bg-slate-800/60 rounded-xl p-4 border border-slate-700/50 shadow-sm">
                  <div className="flex flex-col items-center justify-center py-8 text-slate-500">
                    <Settings className="w-8 h-8 opacity-50 mb-2" />
                    <p className="text-xs">No settings available</p>
                  </div>
                </div>
              )}
            </div>
          </div>
        );
      
      case 'details':
        return (
          <div className="h-full flex flex-col bg-slate-900/80 backdrop-blur-md">
            <div 
              style={panelHeaderStyle}
              className="px-6 flex items-center justify-between border-b border-slate-800/60 bg-slate-900/80 backdrop-blur-md shrink-0"
            >
              <div className="flex items-center gap-2 text-[11px] font-black uppercase tracking-widest text-slate-200">
                <Info strokeWidth={2} className="w-3.5 h-3.5 text-emerald-400" />
                <span>Details</span>
              </div>
              <button
                onClick={() => setActivePanel(null)}
                className="p-2 rounded-lg hover:bg-slate-700/50 text-slate-400 hover:text-slate-200 transition-all"
              >
                <X strokeWidth={1.5} className="w-4 h-4" />
              </button>
            </div>
            <div className="flex-1 overflow-y-auto p-4 space-y-4 min-h-0" style={{ minHeight: 'var(--panel-min-height, 300px)' }}>
              {/* Empty state - same structure as other panels */}
              {items.length === 0 && (
                <div className="bg-slate-800/60 rounded-xl p-4 border border-slate-700/50 shadow-sm">
                  <div className="flex flex-col items-center justify-center py-8 text-slate-500">
                    <Info className="w-8 h-8 opacity-50 mb-2" />
                    <p className="text-xs">No details available</p>
                  </div>
                </div>
              )}
            </div>
          </div>
        );
      
      case 'overview':
        return (
          <div className="h-full flex flex-col bg-slate-900/80 backdrop-blur-md">
            <div 
              style={panelHeaderStyle}
              className="px-6 flex items-center justify-between border-b border-slate-800/60 bg-slate-900/80 backdrop-blur-md shrink-0"
            >
              <div className="flex items-center gap-2 text-[11px] font-black uppercase tracking-widest text-slate-200">
                <LayoutDashboard strokeWidth={2} className="w-3.5 h-3.5 text-emerald-400" />
                <span>Overview</span>
              </div>
              <button
                onClick={() => setActivePanel(null)}
                className="p-2 rounded-lg hover:bg-slate-700/50 text-slate-400 hover:text-slate-200 transition-all"
              >
                <X strokeWidth={1.5} className="w-4 h-4" />
              </button>
            </div>
            <div className="flex-1 overflow-y-auto p-4 space-y-4 min-h-0" style={{ minHeight: 'var(--panel-min-height, 300px)' }}>
              <div className="bg-slate-800/60 rounded-xl p-4 border border-slate-700/50 shadow-sm">
                <div className="flex items-center gap-2 mb-3">
                  <LayoutDashboard className="w-4 h-4 text-emerald-400" />
                  <div className="text-[10px] font-bold text-slate-300 uppercase tracking-wider">
                    Add Items
                  </div>
                </div>
                <div className="space-y-2">
                  <input
                    type="text"
                    value={newItemName}
                    onChange={(e) => setNewItemName(e.target.value)}
                    placeholder="Enter new item name"
                    className="w-full px-3 py-2 bg-slate-900 border border-slate-700 rounded-lg text-xs text-slate-200 placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-emerald-500"
                    onKeyDown={(e) => e.key === 'Enter' && handleAddItem()}
                  />
                  <button
                    onClick={handleAddItem}
                    className="w-full px-3 py-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg text-xs font-medium transition-colors"
                  >
                    Add Item
                  </button>
                </div>
              </div>

              {items.length > 0 ? (
                <div className="bg-slate-800/60 rounded-xl p-4 border border-slate-700/50 shadow-sm">
                  <div className="flex items-center gap-2 mb-3">
                    <LayoutDashboard className="w-4 h-4 text-emerald-400" />
                    <div className="text-[10px] font-bold text-slate-300 uppercase tracking-wider">
                      Items
                    </div>
                  </div>
                  <div className="space-y-2">
                    {items.map((item) => (
                      <div key={item.id} className="p-3 bg-slate-900/50 rounded-lg border border-slate-700/30">
                        <div className="text-sm font-bold text-slate-200">{item.name}</div>
                        <div className="text-xs text-slate-400 mt-1">{item.description}</div>
                      </div>
                    ))}
                  </div>
                </div>
              ) : (
                <div className="bg-slate-800/60 rounded-xl p-4 border border-slate-700/50 shadow-sm">
                  <div className="flex flex-col items-center justify-center py-8 text-slate-500">
                    <LayoutDashboard className="w-8 h-8 opacity-50 mb-2" />
                    <p className="text-xs">No items yet</p>
                  </div>
                </div>
              )}
            </div>
          </div>
        );
      
      default:
        return null;
    }
  };

  return (
    <div 
      className="fixed right-0 top-[150px] h-[calc(100%-150px)] z-30 flex items-start"
      style={{ width: 'auto' }}
    >
      {/* Panel Content - Slides in from left, only one panel at a time */}
      {activePanel && (
        <div 
          style={panelContainerStyle}
          className="bg-slate-900/80 backdrop-blur-md border-r border-slate-800/60 shadow-lg h-full overflow-hidden animate-[slideInFromLeft_0.3s_ease-out]"
        >
          {getActivePanelContent()}
        </div>
      )}
      
      {/* Activity Bar - Always visible, sticks to right - UNIFORM grid layout */}
      <div 
        className="bg-slate-900/80 backdrop-blur-md border-l border-slate-800/60 shadow-md flex flex-col items-stretch justify-start shrink-0 h-full"
        style={{ 
          width: 'var(--activity-bar-width, 48px)',
          minWidth: '48px',
          padding: '6px 0',
          gap: '0'
        }}
      >
        {/* Main Panel Tabs - CSS Grid for uniform sizing */}
        <div className="flex flex-col" style={{ gap: '0' }}>
          <PanelTab
            icon={<Sparkles className="w-4 h-4" strokeWidth={2} />}
            label="ASSISTANT"
            active={chatVisible}
            onClick={onToggleChat}
            tooltip="Assistant Chat"
          />
          <PanelTab
            icon={<Eye className="w-4 h-4" strokeWidth={2} />}
            label="PREVIEW"
            active={previewVisible}
            onClick={onTogglePreview}
            tooltip="Live Preview"
          />
          <PanelTab
            icon={<Activity className="w-4 h-4" strokeWidth={2} />}
            label="INSPECTOR"
            active={inspectorVisible}
            onClick={onToggleInspector}
            tooltip="Code Inspector"
          />
          <PanelTab
            icon={<Terminal className="w-4 h-4" strokeWidth={2} />}
            label="MONITOR"
            active={monitorVisible}
            onClick={onToggleMonitor}
            tooltip="LLM Monitor"
          />
        </div>

        {/* Spacer */}
        <div className="flex-1" />

        {/* Additional Tabs: Overview, Details, Settings - Same uniform sizing */}
        <div className="flex flex-col border-t border-slate-700/50 pt-2" style={{ gap: '0' }}>
          <PanelTab
            icon={<LayoutDashboard className="w-4 h-4" strokeWidth={2} />}
            label="OVERVIEW"
            active={activePanel === 'overview'}
            onClick={() => handleTogglePanel('overview')}
            tooltip="Overview"
          />
          <PanelTab
            icon={<Info className="w-4 h-4" strokeWidth={2} />}
            label="DETAILS"
            active={activePanel === 'details'}
            onClick={() => handleTogglePanel('details')}
            tooltip="Details"
          />
          <PanelTab
            icon={<Settings className="w-4 h-4" strokeWidth={2} />}
            label="SETTINGS"
            active={activePanel === 'settings'}
            onClick={() => handleTogglePanel('settings')}
            tooltip="Settings"
          />
        </div>
      </div>
    </div>
  );
};
